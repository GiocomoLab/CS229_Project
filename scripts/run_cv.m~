% 

function [Y_train,Y_test,Y_hat_train,Y_hat_test,theta] = run_cv(X,Y,fold_inds,model_type,hyperparameters)
   

% for each fold
k = length(fold_inds);  
Y_hat_train = cell(k,1); Y_hat_test = cell(k,1);
Y_train = cell(k,1); Y_test = cell(k,1);
theta = cell(k,1);
for fold = 1:k
%      fold_bool = zeros(k,1); fold_bool(k) = 1; fold_bool = logical(fold_bool);
     inds_test = fold_inds{fold}; 
     if fold ==1
         inds_train = cell2mat(fold_inds(2:end));
     elseif fold == k
         inds_train = cell2mat(fold_inds(1:k-1));
     else
         inds_train = cell2mat(fold_inds([1:k-1 k+1:end]));
     end
     
     X_train = X(inds_train,:); 
     Y_train{fold} = Y(inds_train);
     
     X_test = X(inds_test,:);
     Y_test{fold} = Y(inds_test);

    % build classifier based on inputs
%    and test classifiers
    switch model_type
        case 'linear_svm'
            mdl = fitclinear(X_train,Y_train{fold},'Regularization',...
                hyperparameters{1},'Lambda',hyperparameters{2},...
                'Learner','svm');
            Y_hat_train{fold} = predict(mdl,X_train);
            Y_hat_test{fold} = predict(mdl,X_test);
            theta{fold} = mdl.Beta;
        case 'logistic'
            mdl = fitclinear(X_train,Y_train{fold},'Regularization',...
                hyperparameters{1},'Lambda',hyperparameters{2},...
                'Learner','svm');
            Y_hat_train{fold} = predict(mdl,X_train);
            Y_hat_test{fold} = predict(mdl,X_test);
            theta{fold} = mdl.Beta;
        case 'svm'
            mdl = fitcsvm(X_train,Y_train{fold},'KernelFunction',...
                hyperparameters{1},'KernelScale','auto');
            Y_hat_train{fold} = predict(mdl,X_train);
            Y_hat_test{fold} = predict(mdl,X_test);
            
        case 'mc_linear_svm'
            t = templateLinear('Learner','svm',....
                'Regularization',hyperparameters{1},'Lambda',hyperparameters{2});
            
            mdl = fitcecoc(X_train,Y_train{fold},'Learners',t);
            Y_hat_train{fold} = predict(mdl,X_train)
            Y_hat_test{fold} = T2Y(predict(mdl,X_test));
%             theta{fold} = mdl.Beta;
            
        case 'mc_svm'
            t = templateSVM('Standardize',1,'KernelFunction',hyperparameters{1},...
                'KernelScale','auto');
            mdl = fitcecoc(X_train,Y_train{fold},'Learners',t);
            
            Y_hat_train{fold} = predict(mdl,X_train);
            Y_hat_test{fold} = predict(mdl,X_test);
            
           
        case 'softmax'
            net = trainSoftmaxLayer(X,Y2T(Y_train{fold}));
            net(X_train)
            Y_hat_train{fold} = T2Y(net(X_train));
            Y_hat_test{fold} = T2Y(net(X_test));
            
    end
             
    
end 


end


function T = Y2T(Y)

numClasses = max(Y);

T = zeros(numClasses,length(Y));
for c = 1:numClasses
    T(c,:) = double(Y==c);
end
end

function Y = T2Y(T)

numClasses = size(T,1);
dummyY = [];
for c = 1:numClasses
    dummyY = [dummyY; (c-1)*ones(size(T,2),1)];
end

Y = squeeze(dummyY(logical(T)))';
end

